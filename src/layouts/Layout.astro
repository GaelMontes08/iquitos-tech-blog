---
import Header from "@/components/Header.astro";
import SEO from "@/components/SEO.astro";
import Schema from "@/components/Schema.astro";
import "@/styles/global.css";
import '@fontsource-variable/onest';
import Footer from "@/components/Footer.astro";
import { ViewTransitions } from 'astro:transitions';
import Analytics from '@vercel/analytics/astro';
import type { SEOProps } from '@/lib/seo';

export interface Props extends SEOProps {}

const seoProps = Astro.props as Props;
---

<!doctype html>
<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        
        <style>
          * {
            box-sizing: border-box;
          }
          
          :root {
            font-family: 'Onest Variable', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            color-scheme: dark;
          }
          
          html {
            background-color: #131313;
          }
          
          body {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            min-height: 100vh;
            color: rgba(255, 255, 255, 0.9);
            line-height: 1.6;
          }
          
          /* Critical layout styles */
          .pt-16 { padding-top: 4rem; }
          .text-white { color: rgb(255 255 255); }
          .bg-gray-900 { background-color: rgb(17 24 39); }
        </style>        
        
        <link rel="dns-prefetch" href="//www.googletagmanager.com" />
        <link rel="dns-prefetch" href="//news.google.com" />
        <link rel="preconnect" href="https://www.googletagmanager.com" crossorigin />
        <link rel="preconnect" href="https://news.google.com" crossorigin />
        
        <link rel="dns-prefetch" href="//iquitostech.wordpress.com" />
        <link rel="preconnect" href="https://iquitostech.wordpress.com" crossorigin />
        
        <SEO {...seoProps} />
        <Schema {...seoProps} />
        
        <script is:inline>
          window.dataLayer = window.dataLayer || [];
          function gtag(){dataLayer.push(arguments);}
          gtag('js', new Date());
          gtag('config', 'G-XXGSVHTJJL');
          
          // Performance monitoring
          window.addEventListener('load', function() {
            // Fix accessibility: Add titles to dynamically created iframes
            function addIframeTitles() {
              const iframes = document.querySelectorAll('iframe:not([title])');
              iframes.forEach((iframe, index) => {
                const src = iframe.src || '';
                const className = iframe.className || '';
                const parentElement = iframe.parentElement;
                let title = 'Contenido embebido';
                
                // Identify iframe source and assign appropriate title
                if (src.includes('googletagmanager') || src.includes('google-analytics')) {
                  title = 'Google Analytics - Seguimiento web';
                } else if (src.includes('google.com/recaptcha')) {
                  title = 'Google reCAPTCHA - Verificación de seguridad';
                } else if (src.includes('youtube.com') || src.includes('youtu.be')) {
                  title = 'Video de YouTube embebido';
                } else if (src.includes('twitter.com') || src.includes('x.com')) {
                  title = 'Tweet embebido de Twitter/X';
                } else if (src.includes('facebook.com')) {
                  title = 'Publicación embebida de Facebook';
                } else if (src.includes('instagram.com')) {
                  title = 'Publicación embebida de Instagram';
                } else if (src.includes('tiktok.com')) {
                  title = 'Video embebido de TikTok';
                } else if (src.includes('linkedin.com')) {
                  title = 'Publicación embebida de LinkedIn';
                } else if (src.includes('news.google.com') || src.includes('swg')) {
                  title = 'Google News - Gestor de suscripciones';
                } else if (src.includes('vimeo.com')) {
                  title = 'Video embebido de Vimeo';
                } else if (src.includes('spotify.com')) {
                  title = 'Reproductor embebido de Spotify';
                } else if (src.includes('soundcloud.com')) {
                  title = 'Reproductor embebido de SoundCloud';
                } else if (className.includes('wp-embedded-content')) {
                  title = 'Contenido embebido de WordPress';
                } else if (parentElement && parentElement.classList.contains('wp-block-embed')) {
                  title = 'Contenido multimedia embebido';
                } else if (iframe.style.display === 'none' || iframe.hidden || iframe.width === '0' || iframe.height === '0') {
                  title = 'Marco de seguimiento - Oculto para análisis web';
                } else if (src.includes('ads') || src.includes('doubleclick') || src.includes('googlesyndication')) {
                  title = 'Marco publicitario';
                } else {
                  title = `Contenido embebido ${index + 1}`;
                }
                
                iframe.setAttribute('title', title);
                iframe.setAttribute('aria-label', title);
                
                // Add role for better accessibility
                if (iframe.style.display === 'none' || iframe.hidden) {
                  iframe.setAttribute('aria-hidden', 'true');
                } else {
                  iframe.setAttribute('role', 'application');
                }
              });
            }
            
            // Run immediately and set up observer for dynamically added iframes
            addIframeTitles();
            
            // Also run after a short delay to catch WordPress embeds
            setTimeout(addIframeTitles, 1000);
            setTimeout(addIframeTitles, 3000);
            
            // Watch for new iframes being added
            const observer = new MutationObserver(function(mutations) {
              mutations.forEach(function(mutation) {
                if (mutation.type === 'childList') {
                  mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1) { // Element node
                      // Check if the added node is an iframe or contains iframes
                      if (node.tagName === 'IFRAME' || node.querySelector && node.querySelector('iframe')) {
                        setTimeout(addIframeTitles, 100);
                      }
                    }
                  });
                }
              });
            });
            
            observer.observe(document.body, {
              childList: true,
              subtree: true
            });
            
            // Send Core Web Vitals to Google Analytics
            if (typeof gtag === 'function') {
              // LCP
              new PerformanceObserver((entryList) => {
                for (const entry of entryList.getEntries()) {
                  gtag('event', 'LCP', {
                    custom_map: {metric_value: entry.startTime}
                  });
                }
              }).observe({entryTypes: ['largest-contentful-paint']});
              
              // FID
              new PerformanceObserver((entryList) => {
                for (const entry of entryList.getEntries()) {
                  gtag('event', 'FID', {
                    custom_map: {metric_value: entry.processingStart - entry.startTime}
                  });
                }
              }).observe({entryTypes: ['first-input']});
              
              // CLS
              let clsValue = 0;
              new PerformanceObserver((entryList) => {
                for (const entry of entryList.getEntries()) {
                  if (!entry.hadRecentInput) {
                    clsValue += entry.value;
                  }
                }
                gtag('event', 'CLS', {
                  custom_map: {metric_value: clsValue}
                });
              }).observe({entryTypes: ['layout-shift']});
            }
            
            // Load GA script after page load to improve performance
            var script = document.createElement('script');
            script.async = true;
            script.src = 'https://www.googletagmanager.com/gtag/js?id=G-XXGSVHTJJL';
            document.head.appendChild(script);
          });
        </script>
        
        <script is:inline>
          window.addEventListener('load', function() {
            // Register Service Worker for caching
            if ('serviceWorker' in navigator) {
              navigator.serviceWorker.register('/sw.js')
                .then(registration => {
                  console.log('SW registered:', registration);
                })
                .catch(error => {
                  console.log('SW registration failed:', error);
                });
            }
            
            // Load Google News script
            var swgScript = document.createElement('script');
            swgScript.async = true;
            swgScript.type = 'application/javascript';
            swgScript.src = 'https://news.google.com/swg/js/v1/swg-basic.js';
            document.head.appendChild(swgScript);
            
            swgScript.onload = function() {
              (self.SWG_BASIC = self.SWG_BASIC || []).push( function(basicSubscriptions) {
                basicSubscriptions.init({
                  type: "NewsArticle",
                  isPartOfType: ["Product"],
                  isPartOfProductId: "CAowoPTcCw:openaccess",
                  clientOptions: { theme: "light", lang: "es" },
                });
              });
            };
          });
        </script>
    </head>
    <body>
        <ViewTransitions />
        <Header />
        <main class="pt-16 sm:pt-20 lg:pt-24">
            <slot />
        </main>
        <Footer />
        <Analytics />
    </body>
</html>

<style is:global>
    * {
        box-sizing: border-box;
    }
    
    :root {
        font-family: 'Onest Variable', sans-serif;
        color-scheme: dark;
    }
    
    html {
        background-color: #131313;
    }
    
    body {
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        min-height: 100vh;
    }
    
    @media (min-width: 640px) {
        body {
            padding: 0 1.5rem;
        }
    }
    
    @media (min-width: 1024px) {
        body {
            padding: 0 2rem;
        }
    }
    
    @media (min-width: 1280px) {
        body {
            padding: 0;
        }
    }
    
    ::-webkit-scrollbar {
        width: 8px;
    }
    ::-webkit-scrollbar-track {
        background: transparent;
        backdrop-filter: blur(10px);
        border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb {
        background: rgba(255, 255, 255, 0.3);
        backdrop-filter: blur(10px);
        border-radius: 5px;
    }
    ::-webkit-scrollbar-thumb:hover {
        background: rgba(255, 255, 255, 0.5);
    }
    
    /* Base paragraph styles - only apply outside of prose containers */
    body > *:not(.prose-container) p,
    main > *:not(.prose-container) p,
    section:not(.prose-container) p,
    div:not(.prose-container) p {
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.6;
        margin-bottom: 1em;
        font-weight: 100;
        font-size: 0.875rem;
        letter-spacing: 0.5px;
    }
    
    @media (min-width: 640px) {
        body > *:not(.prose-container) p,
        main > *:not(.prose-container) p,
        section:not(.prose-container) p,
        div:not(.prose-container) p {
            font-size: 1rem;
            line-height: 1.5;
        }
    }
    
    @media (min-width: 1024px) {
        body > *:not(.prose-container) p,
        main > *:not(.prose-container) p,
        section:not(.prose-container) p,
        div:not(.prose-container) p {
            line-height: 1.4;
        }
    }
    
    /* Strong text styling - apply everywhere */
    p strong {
        color: white;
        font-weight: 700;
    }
</style>