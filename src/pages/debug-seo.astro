---
import Layout from '../layouts/Layout.astro';
import { getPostInfo } from '../lib/wordpress';

// Only allow access in development mode OR with secret key
const isDev = !import.meta.env.PROD;
const hasSecretKey = Astro.url.searchParams.get('key') === 'iquitos-debug-2025';

if (!isDev && !hasSecretKey) {
  return Astro.redirect('/404');
}

// Get a sample post for testing
let testPost;
try {
  testPost = await getPostInfo('wukong-la-supercomputadora-china-que-emula-el-cerebro');
} catch (error) {
  testPost = {
    title: 'Sample Post Title',
    content: 'Sample content for testing purposes.',
    date: new Date().toISOString(),
    seo: undefined
  };
}

const sampleSEO = {
  title: testPost?.title || 'Debug Page',
  description: testPost?.content ? testPost.content.replace(/<[^>]*>/g, '').substring(0, 160) + '...' : 'Test description',
  seo: testPost?.seo,
  canonical: `https://iquitostech.com/posts/wukong-la-supercomputadora-china-que-emula-el-cerebro`,
  image: testPost?.seo?.og_image?.[0]?.url,
  type: 'article' as const,
  publishedTime: testPost?.date,
  author: 'Iquitos Tech'
};
---

<Layout {...sampleSEO}>
  <div class="min-h-screen bg-gray-900 text-white p-8">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-3xl font-bold mb-8 text-[#2847d7]">SEO Debug Page</h1>
      
      <div class="bg-gray-800 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Current Post Data:</h2>
        <div class="space-y-2 text-sm">
          <p><strong>Title:</strong> {testPost?.title || 'No title'}</p>
          <p><strong>Has SEO Data:</strong> {testPost?.seo ? 'Yes' : 'No'}</p>
          <p><strong>OG Image:</strong> {testPost?.seo?.og_image?.[0]?.url || 'None'}</p>
          <p><strong>Canonical:</strong> {testPost?.seo?.canonical || 'None'}</p>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg p-6 mb-8">
        <h2 class="text-xl font-semibold mb-4">Test Your URLs:</h2>
        <div class="space-y-4">
          <div>
            <h3 class="font-semibold text-[#2847d7] mb-2">Facebook Sharing Debugger:</h3>
            <a href="https://developers.facebook.com/tools/debug/" target="_blank" 
               class="text-blue-400 hover:text-blue-300 underline">
              Facebook Sharing Debugger Tool
            </a>
            <p class="text-sm text-gray-400 mt-1">
              Test URL: https://iquitostech.com/posts/wukong-la-supercomputadora-china-que-emula-el-cerebro
            </p>
          </div>
          
          <div>
            <h3 class="font-semibold text-[#2847d7] mb-2">WhatsApp Link Preview:</h3>
            <p class="text-sm text-gray-400">
              WhatsApp uses the same Open Graph data as Facebook. If Facebook works, WhatsApp should too.
            </p>
          </div>
          
          <div>
            <h3 class="font-semibold text-[#2847d7] mb-2">Twitter Card Validator:</h3>
            <a href="https://cards-dev.twitter.com/validator" target="_blank" 
               class="text-blue-400 hover:text-blue-300 underline">
              Twitter Card Validator
            </a>
          </div>
        </div>
      </div>

      <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Common Issues & Solutions:</h2>
        <div class="space-y-4 text-sm">
          <div>
            <h3 class="font-semibold text-[#2847d7]">1. Local Development</h3>
            <p class="text-gray-400">Facebook/WhatsApp can't access localhost. Deploy to production first.</p>
          </div>
          
          <div>
            <h3 class="font-semibold text-[#2847d7]">2. Image Issues</h3>
            <p class="text-gray-400">
              • Images must be publicly accessible<br/>
              • Recommended size: 1200x630px<br/>
              • Supported formats: JPG, PNG (SVG may not work)
            </p>
          </div>
          
          <div>
            <h3 class="font-semibold text-[#2847d7]">3. Cache Issues</h3>
            <p class="text-gray-400">
              Facebook caches previews. Use the Facebook Debugger to refresh the cache.
            </p>
          </div>
          
          <div>
            <h3 class="font-semibold text-[#2847d7]">4. Required Tags</h3>
            <p class="text-gray-400">
              • og:title ✓<br/>
              • og:description ✓<br/>
              • og:image ✓<br/>
              • og:url ✓
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</Layout>
